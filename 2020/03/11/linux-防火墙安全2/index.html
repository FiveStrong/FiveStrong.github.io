<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linux 防火墙安全（2） - モルガンナの家</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Morgana" /><meta name="description" content="nftables 概述 nftables 引入的新特证： 之前不同的网络操作需要安装特定的工具，比如 iptables, ip6tables, ebtables, arptables 等等，现在都被整合到了 nft 这一个工具包中。 nftables 采用多维树状结构展示规则集" /><meta name="keywords" content="Hugo, モルガンナの家" />






<meta name="generator" content="Hugo 0.61.0 with theme even" />


<link rel="canonical" href="http://linuxfunk.com/2020/03/11/linux-%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%89%E5%85%A82/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.c6027d52fe21dac0e1e0f5d733e108dbb77b0720664fde93151746da29085e21.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Linux 防火墙安全（2）" />
<meta property="og:description" content="nftables 概述 nftables 引入的新特证： 之前不同的网络操作需要安装特定的工具，比如 iptables, ip6tables, ebtables, arptables 等等，现在都被整合到了 nft 这一个工具包中。 nftables 采用多维树状结构展示规则集" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://linuxfunk.com/2020/03/11/linux-%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%89%E5%85%A82/" />
<meta property="article:published_time" content="2020-03-11T17:06:48+08:00" />
<meta property="article:modified_time" content="2020-03-11T17:06:48+08:00" />
<meta itemprop="name" content="Linux 防火墙安全（2）">
<meta itemprop="description" content="nftables 概述 nftables 引入的新特证： 之前不同的网络操作需要安装特定的工具，比如 iptables, ip6tables, ebtables, arptables 等等，现在都被整合到了 nft 这一个工具包中。 nftables 采用多维树状结构展示规则集">
<meta itemprop="datePublished" content="2020-03-11T17:06:48&#43;08:00" />
<meta itemprop="dateModified" content="2020-03-11T17:06:48&#43;08:00" />
<meta itemprop="wordCount" content="5374">



<meta itemprop="keywords" content="firewall," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux 防火墙安全（2）"/>
<meta name="twitter:description" content="nftables 概述 nftables 引入的新特证： 之前不同的网络操作需要安装特定的工具，比如 iptables, ip6tables, ebtables, arptables 等等，现在都被整合到了 nft 这一个工具包中。 nftables 采用多维树状结构展示规则集"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">モルガンナの家</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">モルガンナの家</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Linux 防火墙安全（2）</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-11 </span>
        <div class="post-category">
            <a href="/categories/linux/"> linux </a>
            </div>
          <span class="more-meta"> 约 5374 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#nftables-">nftables 概述</a>
          <ul>
            <li><a href="#nftables--1">了解nftables 的表和链</a></li>
            <li><a href="#nftables--2">nftables 应用</a></li>
            <li><a href="#-nft-">使用 nft 命令行</a></li>
          </ul>
        </li>
        <li><a href="#firewalld-">firewalld 概述</a>
          <ul>
            <li><a href="#-firewalld-">管理 firewalld 状态</a></li>
            <li><a href="#-firewalld-zones">了解 firewalld zones</a></li>
            <li><a href="#-zone-">向 zone 中添加需要开启的服务</a></li>
            <li><a href="#-zone--1">向 zone 中添加需要开启的端口</a></li>
            <li><a href="#icmp-">ICMP 包阻断</a></li>
            <li><a href="#pinic-">pinic 模式</a></li>
            <li><a href="#heading">日志记录丢弃包的信息</a></li>
            <li><a href="#-rich-language-rules">编写 rich language rules</a></li>
          </ul>
        </li>
        <li><a href="#heading-1">推荐阅读</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="nftables-">nftables 概述</h2>
<p>nftables 引入的新特证：</p>
<ul>
<li>之前不同的网络操作需要安装特定的工具，比如 iptables, ip6tables, ebtables, arptables 等等，现在都被整合到了 nft 这一个工具包中。</li>
<li>nftables 采用多维树状结构展示规则集，这使得调试数据包匹配了哪些规则变得更加容易。</li>
<li>在 iptables 中不管你用不用，默认都建立了 filter, NAT, mangle, security 这些表；而在 nftables 中， 你仅需要创建需要的表，这将拥有更高效的性能。</li>
<li>nftables 可以在一条规则中指定多个行为，而不用像 iptables 中那样需要为每个行为创建多条规则。</li>
<li>添加一条新的规则之后，这条规则会立刻生效，而不用像之前一样需要重新加载整个规则表。</li>
<li>nftables 有自己内建的脚本引擎，在脚本中调用会更加的高效且易读。</li>
<li>对应已有的调用 iptables 的脚本，可以使用相关的工具将它转化成 nftables 格式。</li>
</ul>
<p>nftables 还在不断的完善中，所以有一些高阶的功能还得基于 iptables 的解决方案，但是随着版本的迭代，功能会越来越完善。所以要时刻留意版本的变更：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 ~<span class="o">]</span><span class="c1"># nft -v</span>
nftables v0.9.0 <span class="o">(</span>Fearless Fosdick<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="nftables--1">了解nftables 的表和链</h3>
<ul>
<li>Tables: nftables 中的表指代特定的协议族，拥有类型：ip, ip6, inet, arp, bridge, netdev 。</li>
<li>Chains： nftables 的链大致相当于 iptables 的表，比如在 nftables 中可以使用 filter, route, 或者 NAT 链。</li>
</ul>
<h3 id="nftables--2">nftables 应用</h3>
<p>还是以 Ubuntu 系统为例，将 ufw 关闭, 安装 nftables</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo ufw disable
sudo systemctl disable --now ufw
sudo apt install nftables
</code></pre></td></tr></table>
</div>
</div><p>查看 安装的表 ，啥也没有</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft list tables
</code></pre></td></tr></table>
</div>
</div><p>开启服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo systemctl start nftables
</code></pre></td></tr></table>
</div>
</div><p>Ubuntu 20.04 中，nftables 的配置文件基本设置为空，需要你手动替换。</p>
<p>我们可以查看一下软件自带的一些样例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ubuntu-2004: <span class="nb">cd</span> /usr/share/doc/nftables/examples
ubuntu@ubuntu-2004:/usr/share/doc/nftables/examples$ ls -l
total <span class="m">92</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">1016</span> Dec <span class="m">17</span> 07:49 all-in-one.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">129</span> Dec <span class="m">17</span> 07:49 arp-filter.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">197</span> Dec <span class="m">17</span> 07:49 bridge-filter.nft
-rwxr-xr-x <span class="m">1</span> root root <span class="m">1263</span> Dec  <span class="m">2</span> 15:00 ct_helpers.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">187</span> Dec <span class="m">17</span> 07:49 inet-filter.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">251</span> Dec <span class="m">17</span> 07:49 inet-nat.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">182</span> Dec <span class="m">17</span> 07:49 ipv4-filter.nft
-rw-r--r-- <span class="m">1</span> root root   <span class="m">74</span> Dec <span class="m">17</span> 07:49 ipv4-mangle.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">246</span> Dec <span class="m">17</span> 07:49 ipv4-nat.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">137</span> Dec <span class="m">17</span> 07:49 ipv4-raw.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">186</span> Dec <span class="m">17</span> 07:49 ipv6-filter.nft
-rw-r--r-- <span class="m">1</span> root root   <span class="m">78</span> Dec <span class="m">17</span> 07:49 ipv6-mangle.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">253</span> Dec <span class="m">17</span> 07:49 ipv6-nat.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">141</span> Dec <span class="m">17</span> 07:49 ipv6-raw.nft
-rwxr-xr-x <span class="m">1</span> root root <span class="m">1858</span> Dec  <span class="m">2</span> 15:00 load_balancing.nft
-rwxr-xr-x <span class="m">1</span> root root <span class="m">1165</span> Dec  <span class="m">3</span> 08:10 nat.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">128</span> Dec <span class="m">17</span> 07:49 netdev-ingress.nft
-rwxr-xr-x <span class="m">1</span> root root <span class="m">1077</span> Dec  <span class="m">3</span> 08:10 overview.nft
-rw-r--r-- <span class="m">1</span> root root  <span class="m">475</span> Dec  <span class="m">3</span> 08:10 README
-rwxr-xr-x <span class="m">1</span> root root <span class="m">2413</span> Dec  <span class="m">2</span> 15:00 secmark.nft
-rwxr-xr-x <span class="m">1</span> root root <span class="m">1278</span> Dec  <span class="m">2</span> 15:00 sets_and_maps.nft
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Mar <span class="m">11</span> 23:16 sysvinit
-rwxr-xr-x <span class="m">1</span> root root  <span class="m">577</span> Dec  <span class="m">3</span> 08:10 workstation.nft
</code></pre></td></tr></table>
</div>
</div><p>将 <code>workstation.nft</code> 替换到 <code>/etc/nftables.conf</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo cp workstation.nft /etc/nftables.conf

cat /etc/nftables.conf
<span class="c1">#!/usr/sbin/nft -f</span>

flush ruleset

table inet filter <span class="o">{</span>
	chain input <span class="o">{</span>
		<span class="nb">type</span> filter hook input priority 0<span class="p">;</span>

		<span class="c1"># accept any localhost traffic</span>
		iif lo accept

		<span class="c1"># accept traffic originated from us</span>
		ct state established,related accept

		<span class="c1"># activate the following line to accept common local services</span>
		<span class="c1">#tcp dport { 22, 80, 443 } ct state new accept</span>

		<span class="c1"># accept neighbour discovery otherwise IPv6 connectivity breaks.</span>
		ip6 nexthdr icmpv6 icmpv6 <span class="nb">type</span> <span class="o">{</span> nd-neighbor-solicit,  nd-router-advert, nd-neighbor-advert <span class="o">}</span> accept

		<span class="c1"># count and drop any other traffic</span>
		counter drop
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个配置文件内容有：</p>
<ul>
<li>#! /usr/sbin/nft -f : 类似于 shell 脚本的 #!/bin/sh，使用 nftables 内置的脚本引擎，这样就不需要在每一条需要执行的命令前面再添加 nft 命令</li>
<li>flush ruleset: 清除所有已经加载的规则。</li>
<li>table inet filter : 创建一个 inet 协议族的 filter，这将对 IPv4 IPv6都有效。这个表的名字就叫 filter（名称可以自定义）。</li>
<li>chain input: 定义 input 链（名称可以自定义）</li>
<li>type filter hook input priority: 定义这个链的类型为 filter ，<strong>hook input</strong> 表示用途是处理入流量的包，由于同时定义了 hook 和 priority ， 这条规则将直接从网络栈中接收包数据。</li>
<li>iif  lo accept : 允许 本地回环网卡 接收数据包。</li>
<li>下一行是标准的 connection tracking ( ct ) 规则，允许已连接请求的响应数据。</li>
<li>下一行注释掉的规则表示开放 ssh web 端口，<strong>ct state new</strong> 表示允许其他主机通过这几个端口进行通信。</li>
<li>下一行是 ipv6 相关规则，放行用于邻居发现的包，是Ipv6可用。</li>
<li>最后一行阻止所有其他的流量并记录阻挡的包数以及字节数。这是一个一条规则实现多个行为的典型规则。</li>
</ul>
<p>一般情况下，使用 nftables  设置防火墙，最简单粗暴的方法就是根据需求修改 /etc/nftables.conf 文件。现在假设是一台DNS服务器，那么相关的配置就是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">tcp dport { 22, 53 } ct state new accept // 开放多个端口
udp dport 53 ct state new accept
</code></pre></td></tr></table>
</div>
</div><p>重载配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo systemctl reload nftables
ubuntu@ubuntu-2004:~$ sudo nft list ruleset
table inet filter <span class="o">{</span>
	chain input <span class="o">{</span>
		<span class="nb">type</span> filter hook input priority filter<span class="p">;</span> policy accept<span class="p">;</span>
		iif <span class="s2">&#34;lo&#34;</span> accept
		ct state established,related accept
		tcp dport <span class="o">{</span> 22, <span class="m">53</span> <span class="o">}</span> ct state new accept
		udp dport <span class="m">53</span> ct state new accept
		ip6 nexthdr ipv6-icmp icmpv6 <span class="nb">type</span> <span class="o">{</span> nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert <span class="o">}</span> accept
		counter packets <span class="m">5</span> bytes <span class="m">380</span> drop
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后的 counter drop 规则丢弃不合法的数据包，可以将这些记录添加到日志 /var/log/kern.log 中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">counter log prefix <span class="s2">&#34;Dropped Packet: &#34;</span> drop
</code></pre></td></tr></table>
</div>
</div><p>现在假设需要限制其他IP登录该主机的22端口，可以添加规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">tcp dport <span class="m">22</span> ip saddr <span class="o">{</span> 192.168.50.55, 192.168.50.11 <span class="o">}</span> log prefix <span class="s2">&#34;Blocked SSH packets: &#34;</span> drop
tcp dport <span class="o">{</span> 22, <span class="m">53</span> <span class="o">}</span> ct state new accept
</code></pre></td></tr></table>
</div>
</div><p>这时候如果尝试用被封主机登录就会看到日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Mar <span class="m">12</span> 02:20:17 ubuntu-2004 kernel: <span class="o">[</span>94037.467972<span class="o">]</span> Blocked SSH packets: <span class="nv">IN</span><span class="o">=</span>enp0s5 <span class="nv">OUT</span><span class="o">=</span> <span class="nv">MAC</span><span class="o">=</span>00:1c:42:76:a5:22:00:1c:42:af:3a:a5:08:00 <span class="nv">SRC</span><span class="o">=</span>192.168.50.55 <span class="nv">DST</span><span class="o">=</span>192.168.50.54 <span class="nv">LEN</span><span class="o">=</span><span class="m">60</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">42006</span> DF <span class="nv">PROTO</span><span class="o">=</span>TCP <span class="nv">SPT</span><span class="o">=</span><span class="m">46446</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">22</span> <span class="nv">WINDOW</span><span class="o">=</span><span class="m">29200</span> <span class="nv">RES</span><span class="o">=</span>0x00 SYN <span class="nv">URGP</span><span class="o">=</span><span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p>接着允许特定的 ICMP 包，注意，这里IPv4 IPv6 需要分开来写</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ct state new,related,established icmp <span class="nb">type</span> <span class="o">{</span> destination-unreachable, time-exceeded, parameter-problem <span class="o">}</span> accept
                ct state established,related,new icmpv6 <span class="nb">type</span> <span class="o">{</span> destination-unreachable, time-exceeded, parameter-problem <span class="o">}</span> accept
</code></pre></td></tr></table>
</div>
</div><p>接着在 filter 表中添加一个 prerouting 链来封禁不合法包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">chain prerouting <span class="o">{</span>
				<span class="nb">type</span> filter hook prerouting priority 0<span class="p">;</span>
				ct state invalid counter log prefix <span class="s2">&#34;Invalid Packets: &#34;</span> drop
				tcp flags <span class="p">&amp;</span> <span class="o">(</span>fin<span class="p">|</span>syn<span class="p">|</span>rst<span class="p">|</span>ack<span class="o">)</span> !<span class="o">=</span> syn ct state new counter log drop
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后完全配置好的文件为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/usr/sbin/nft -f
</span><span class="cp"></span>
flush ruleset

table inet filter <span class="o">{</span>
	chain input <span class="o">{</span>
		<span class="nb">type</span> filter hook input priority 0<span class="p">;</span>

		<span class="c1"># accept any localhost traffic</span>
		iif lo accept

		<span class="c1"># accept traffic originated from us</span>
		ct state established,related accept

		<span class="c1"># activate the following line to accept common local services</span>
		<span class="c1">#tcp dport { 22, 80, 443 } ct state new accept</span>

                tcp dport <span class="m">22</span> ip saddr <span class="o">{</span> 192.168.50.55, 192.168.50.11 <span class="o">}</span> log prefix <span class="s2">&#34;Blocked SSH packets: &#34;</span> drop

                tcp dport <span class="o">{</span> 22, <span class="m">53</span> <span class="o">}</span> ct state new accept
                udp dport <span class="m">53</span> ct state new accept
                ct state new,related,established icmp <span class="nb">type</span> <span class="o">{</span> destination-unreachable, time-exceeded, parameter-problem <span class="o">}</span> accept
                ct state established,related,new icmpv6 <span class="nb">type</span> <span class="o">{</span> destination-unreachable, time-exceeded, parameter-problem <span class="o">}</span> accept

		<span class="c1"># accept neighbour discovery otherwise IPv6 connectivity breaks.</span>
		ip6 nexthdr icmpv6 icmpv6 <span class="nb">type</span> <span class="o">{</span> nd-neighbor-solicit,  nd-router-advert, nd-neighbor-advert <span class="o">}</span> accept

		<span class="c1"># count and drop any other traffic</span>
		counter log prefix <span class="s2">&#34;Dropped Packet: &#34;</span> drop
	<span class="o">}</span>
        chain prerouting <span class="o">{</span>
				<span class="nb">type</span> filter hook prerouting priority 0<span class="p">;</span>
				ct state invalid counter log prefix <span class="s2">&#34;Invalid Packets: &#34;</span> drop
				tcp flags <span class="p">&amp;</span> <span class="o">(</span>fin<span class="p">|</span>syn<span class="p">|</span>rst<span class="p">|</span>ack<span class="o">)</span> !<span class="o">=</span> syn ct state new counter log drop
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过配置文件可以看出，我们可以在同一个文件中同时配置 IPv4 IPv6规则，并且使用 inet 表，这些规则能够同时运用于IPv4，IPv6，除非你有特殊需求，否则 inet 类型的表使用的优先级高于单独的 IPv4， IPv6 类型表。</p>
<h3 id="-nft-">使用 nft 命令行</h3>
<p>删除之前的规则，用命令行创建新的规则。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft delete table inet filter
sudo nft list tables
sudo nft add table inet ubuntu_filter
sudo nft list tables
</code></pre></td></tr></table>
</div>
</div><p>接着添加新的链，特别注意最后的分号要加转义字符</p>
<p><code>注意</code>： 如果是通过ssh远程连接的千万不要执行这条命令，因为 nft 命令行会立马生效， 导致你被立刻断开连接。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft add chain inet ubuntu_filter input <span class="o">{</span> <span class="nb">type</span> filter hook input priority 0<span class="se">\;</span> policy drop<span class="se">\;</span><span class="o">}</span> 
</code></pre></td></tr></table>
</div>
</div><p>每一个 nftables 的协议族都拥有自己的系统勾子，用来在不同阶段处理流量包。只考虑 ip/ip6/inet 协议族的话，一般有这5个勾子：</p>
<ul>
<li>Prerouting</li>
<li>Input</li>
<li>Forward</li>
<li>Output</li>
<li>Postrouting</li>
</ul>
<p>filter 类型的链只需要考虑 input 和 output 勾子就好了。通过在 自定义 链上设置勾子以及优先级，表示这个链接收直接来自网络栈的数据包。在命令的最后还添加了 policy drop 作为默认协议，如果不加则默认为 accept 。</p>
<p>为了不被断开，我们还需要添加一些必要的规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft add rule inet ubuntu_filter input ct state established accept
sudo nft add rule inet ubuntu_filter input tcp dport <span class="m">22</span> ct state new accept
</code></pre></td></tr></table>
</div>
</div><p>这样得到的结果是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@ubuntu-2004:~# sudo nft list table inet ubuntu_filter
table inet ubuntu_filter <span class="o">{</span>
	chain input <span class="o">{</span>
		<span class="nb">type</span> filter hook input priority filter<span class="p">;</span> policy drop<span class="p">;</span>
		ct state established accept
		tcp dport <span class="m">22</span> ct state new accept
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>除了这些我们还忘了添加对于本地回环网卡的规则， 可以使用 insert 将规则<code>添加</code>到最上面：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft insert rule inet ubuntu_filter input iif lo accept
</code></pre></td></tr></table>
</div>
</div><p>结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">table inet ubuntu_filter <span class="o">{</span>
	chain input <span class="o">{</span>
		<span class="nb">type</span> filter hook input priority filter<span class="p">;</span> policy drop<span class="p">;</span>
		iif <span class="s2">&#34;lo&#34;</span> accept
		ct state established accept
		tcp dport <span class="m">22</span> ct state new accept
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>除了能插入规则到最上面，还可以选取任意位置，这时候可以先查看现有规则的 rule handles</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@ubuntu-2004:~# sudo nft list table inet ubuntu_filter -a
table inet ubuntu_filter <span class="o">{</span> <span class="c1"># handle 15</span>
	chain input <span class="o">{</span> <span class="c1"># handle 1</span>
		<span class="nb">type</span> filter hook input priority filter<span class="p">;</span> policy drop<span class="p">;</span>
		iif <span class="s2">&#34;lo&#34;</span> accept <span class="c1"># handle 4</span>
		ct state established accept <span class="c1"># handle 2</span>
		tcp dport <span class="m">22</span> ct state new accept <span class="c1"># handle 3</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>假设现在需要<code>添加</code>一条阻止特定 ip 登录 ssh的规则，这条规则需要在允许ssh登录规则之上才能生效</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sudo nft insert rule inet ubuntu_filter input position 3 tcp dport 22 ip saddr { 192.168.50.55 } drop
</code></pre></td></tr></table>
</div>
</div><p>结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@ubuntu-2004:~# sudo nft list table inet ubuntu_filter -a
table inet ubuntu_filter <span class="o">{</span> <span class="c1"># handle 15</span>
	chain input <span class="o">{</span> <span class="c1"># handle 1</span>
		<span class="nb">type</span> filter hook input priority filter<span class="p">;</span> policy drop<span class="p">;</span>
		iif <span class="s2">&#34;lo&#34;</span> accept <span class="c1"># handle 4</span>
		ct state established accept <span class="c1"># handle 2</span>
		tcp dport <span class="m">22</span> ip saddr <span class="o">{</span> 192.168.50.55 <span class="o">}</span> drop <span class="c1"># handle 6</span>
		tcp dport <span class="m">22</span> ct state new accept <span class="c1"># handle 3</span>
	<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>接下来我们<code>删除</code>这条规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo nft delete rule inet ubuntu_filter input handle <span class="m">6</span>
</code></pre></td></tr></table>
</div>
</div><p>这些规则会在系统重启之后失效，所以最好写入到 nftables.conf 配置文件中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo sh -c <span class="s2">&#34;nft list table inet ubuntu_filter &gt; /etc/nftables.conf&#34;</span>  
</code></pre></td></tr></table>
</div>
</div><p>这样重定向之后的配置文件还缺少了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/usr/sbin/nft -f 
</span><span class="cp"></span>flush ruleset
</code></pre></td></tr></table>
</div>
</div><p>加上之后重新加载配置文件，就能还原我们之前的配置。</p>
<h2 id="firewalld-">firewalld 概述</h2>
<p>Firewalld 是RHEL/CentOS7和RHEL/CentOS8默认的防火墙管理软件，但是这两个版本还有所差别：7版本的 firewalld 是以 iptables 作为后台引擎，而8版本则换成了 nftables 作为后端引擎。同时 firewalld 与它所用后端引擎的使用方法还不同，它有自己的一套存储规则的方式。</p>
<p>Firewalld 的一个优点是规则动态管理，不用重启 firewall 服务就能加载规则，同时不会断开已有服务连接。</p>
<h3 id="-firewalld-">管理 firewalld 状态</h3>
<ol>
<li><code>sudo firewall-cmd --state</code></li>
<li><code>sudo systemctl status firewalld</code></li>
</ol>
<h3 id="-firewalld-zones">了解 firewalld zones</h3>
<p>Firewalld 预设了很多 zones，配置文件在 /usr/lib/firewalld/zones 目录下面， 它们是 .xml 格式的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /usr/lib/firewalld/zones
<span class="o">[</span>root@centos8 zones<span class="o">]</span><span class="c1"># ls</span>
block.xml  dmz.xml  drop.xml  external.xml  home.xml  internal.xml  public.xml  trusted.xml  work.xml
</code></pre></td></tr></table>
</div>
</div><p>这里的每个 zone 文件代表一种特定的使用场景，建议了在这种情况下哪些端口开，哪些端口关闭。</p>
<p>以 public zone 为例，我们看一下它的默认设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
&lt;zone&gt;
  &lt;short&gt;Public&lt;/short&gt;
  &lt;description&gt;For use in public areas. You <span class="k">do</span> not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.&lt;/description&gt;
  &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;ssh&#34;</span>/&gt;
  &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;dhcpv6-client&#34;</span>/&gt;
&lt;/zone&gt;
</code></pre></td></tr></table>
</div>
</div><p>可以看到 public zone 默认开了 ssh ipv6-dhcp 服务</p>
<p>也可以使用 firewall-cmd 命令查看系统上所有的 zones 列表，这样就不用进入 zone 目录查看了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --get-zones
<span class="o">[</span>root@centos8 zones<span class="o">]</span><span class="c1"># sudo firewall-cmd --get-zones</span>
block dmz drop external home internal public trusted work
</code></pre></td></tr></table>
</div>
</div><p>查看所有 zone 具体的配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --list-all-zones
block
  target: %%REJECT%%
  icmp-block-inversion: no
  interfaces:
  sources:
  services:
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
  ...
  ...
</code></pre></td></tr></table>
</div>
</div><p>查看具体某一个 zone 配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sudo firewall-cmd --info-zone=internal
</code></pre></td></tr></table>
</div>
</div><p>现代电脑可能存在多个网卡，每一个网卡都能且仅可以配置一个 zone，查看默认 zone 命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --get-default-zone
</code></pre></td></tr></table>
</div>
</div><p>查看激活的 zone 所对应的网卡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --get-active-zones
</code></pre></td></tr></table>
</div>
</div><p>系统安装之后默认激活的是 public zone ，假设我们想要将它更改为 dmz zone</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
&lt;zone&gt;
  &lt;short&gt;DMZ&lt;/short&gt;
  &lt;description&gt;For computers in your demilitarized zone that are publicly-accessible with limited access to your internal network. Only selected incoming connections are accepted.&lt;/description&gt;
  &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;ssh&#34;</span>/&gt;
&lt;/zone&gt;
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --set-default-zone<span class="o">=</span>dmz
<span class="o">[</span>root@centos8 zones<span class="o">]</span><span class="c1"># sudo firewall-cmd --get-default-zone</span>
dmz
</code></pre></td></tr></table>
</div>
</div><p>默认的 dmz zone  仅仅放开了 ssh 服务，日常工作中我们需要开放更多的服务。除了使用firewall-cmd 添加，我们也可以直接修改配置文件。但是一般情况下不要修改 /usr/lib/firewalld 目录下的文件，正确的修改地方是 /etc/firewalld 目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># ls</span>
firewalld.conf  firewalld.conf.old  helpers  icmptypes  ipsets  lockdown-whitelist.xml  services  zones
</code></pre></td></tr></table>
</div>
</div><p>因为我们修改了默认 zone ， 所以 firewalld.conf 会有新旧配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo diff /etc/firewalld/firewalld.conf /etc/firewalld/firewalld.conf.old</span>
6c6
&lt; <span class="nv">DefaultZone</span><span class="o">=</span>dmz
---
&gt; <span class="nv">DefaultZone</span><span class="o">=</span>public
</code></pre></td></tr></table>
</div>
</div><h3 id="-zone-">向 zone 中添加需要开启的服务</h3>
<p>firewalld 默认提供很多常见服务名称，这些名称代表的服务会帮我们开启所需要的端口，这样极大的简化了我们手动添加端口的操作，这些服务器文件存放在 /usr/lib/firewalld/services 目录，可以通过命令查看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># firewall-cmd --get-services</span>
RH-Satellite-6 amanda-client amanda-k5-client amqp amqps apcupsd audit bacula bacula-client bb bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc bittorrent-lsd ceph ceph-mon cfengine cockpit condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns dns-over-tls docker-registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-server finger freeipa-4 freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp ganglia-client ganglia-master git grafana gre high-availability http https imap imaps ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kdeconnect kerberos kibana klogin kpasswd kprop kshell ldap ldaps libvirt libvirt-tls lightning-network llmnr managesieve matrix mdns memcache minidlna mongodb mosh mountd mqtt mqtt-tls ms-wbt mssql murmur mysql nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt-storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s postgresql privoxy prometheus proxy-dhcp ptp pulseaudio puppetmaster quassel radius rdp redis redis-sentinel rpc-bind rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips slp smtp smtp-submission smtps snmp snmptrap spideroak-lansync spotify-sync squid ssdp ssh steam-streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet tentacle tftp tftp-client tile38 tinc tor-socks transmission-client upnp-client vdsm vnc-server wbem-http wbem-https wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-server zabbix-agent zabbix-server
</code></pre></td></tr></table>
</div>
</div><p>在添加新的服务之前，我们可以看看当前开启了哪些服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --list-services</span>
ssh
</code></pre></td></tr></table>
</div>
</div><p>如果说需要添加服务，比如说 dropbox-lansync 服务，那么可以提前查看该服务所开启的端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-service=dropbox-lansync</span>
dropbox-lansync
  ports: 17500/udp 17500/tcp
  protocols:
  source-ports:
  modules:
  destination:
  includes:
</code></pre></td></tr></table>
</div>
</div><p>现在将默认 zone 设置为 dmz zone，查看它的信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules
</code></pre></td></tr></table>
</div>
</div><p>当前仅有ssh一个服务开启， 我们来添加 web server 服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --add-service<span class="o">=</span>http
</code></pre></td></tr></table>
</div>
</div><p>再次查看结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: http ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
</code></pre></td></tr></table>
</div>
</div><p>但是如果我们加上 &ndash;permanent 选项后</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --permanent --info-zone=dmz</span>
dmz
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
</code></pre></td></tr></table>
</div>
</div><p>这就表明当前添加的规则没有永久生效，在系统重启之后就会消失。所以为了永久生效，添加命令需要加上 &ndash;permanent 选项，但是加了这个选项之后，你需要重载配置才能让它生效；而不加这个选项，配置立马生效。</p>
<p>配置重载命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --reload
</code></pre></td></tr></table>
</div>
</div><p>删除服务只需要将 <code>--add-service</code> 换成 <code>--remove-service</code> 就行。</p>
<h3 id="-zone--1">向 zone 中添加需要开启的端口</h3>
<p>有一些服务的端口没有在 firewalld 于定义的服务列表中，这时候就需要我们手动去添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --permanent --add-port<span class="o">=</span>10000/tcp //将端口10000永久添加到默认zone配置中
sudo firewall-cmd --reload // 让配置生效
</code></pre></td></tr></table>
</div>
</div><p>同时添加多个端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --add-port<span class="o">=</span><span class="o">{</span>636/tcp, 637/tcp, 638/udp<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>同理，删除端口使用 <code>--remove-port</code> 选项</p>
<p>如果不想每条命令都加上 &ndash;permanent 选项，可以等到全部添加完毕之后，统一设置为 permanent</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --runtime-to-permanent
</code></pre></td></tr></table>
</div>
</div><h3 id="icmp-">ICMP 包阻断</h3>
<p>我们查看 dmz zone 的信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: http ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
</code></pre></td></tr></table>
</div>
</div><p>可以看到有一行 icmp-blocks 信息，后面为空，表示允许所有ICMP包。为了安全起见，我们需要阻断一些类型的ICMP包。firewall 可以方便的查看 ICMP 包的类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --get-icmptypes</span>
address-unreachable bad-header beyond-scope communication-prohibited destination-unreachable echo-reply echo-request failed-policy fragmentation-needed host-precedence-violation host-prohibited host-redirect host-unknown host-unreachable ip-header-bad neighbour-advertisement neighbour-solicitation network-prohibited network-redirect network-unknown network-unreachable no-route packet-too-big parameter-problem port-unreachable precedence-cutoff protocol-unreachable redirect reject-route required-option-missing router-advertisement router-solicitation source-quench source-route-failed time-exceeded timestamp-reply timestamp-request tos-host-redirect tos-host-unreachable tos-network-redirect tos-network-unreachable ttl-zero-during-reassembly ttl-zero-during-transit unknown-header-type unknown-option
</code></pre></td></tr></table>
</div>
</div><p>可以查看这些类型的具体信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-icmptype=network-redirect</span>
network-redirect
  destination: ipv4
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-icmptype=neighbour-advertisement</span>
neighbour-advertisement
  destination: ipv6
</code></pre></td></tr></table>
</div>
</div><p>查看是否阻断特定类型的icmp包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --query-icmp-block=host-redirect</span>
no
</code></pre></td></tr></table>
</div>
</div><p>添加对 redirects 类型的阻断</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --add-icmp-block=host-redirect</span>
success
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --query-icmp-block=host-redirect</span>
yes
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: http ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks: host-redirect
  rich rules:
  
<span class="c1">## 同时添加多个类型</span>
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --add-icmp-block={host-redirect,network-redirect}</span>
Warning: ALREADY_ENABLED: <span class="s1">&#39;host-redirect&#39;</span> already in <span class="s1">&#39;dmz&#39;</span>
success
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: http ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks: host-redirect network-redirect
  rich rules:
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --runtime-to-permanent</span>
success
</code></pre></td></tr></table>
</div>
</div><h3 id="pinic-">pinic 模式</h3>
<p>开启关闭命令，这将会立刻关闭所有网络连接，所以如果是远程连接的，千万不要这么做！！！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --panic-on
sudo firewall-cmd --panic-off
</code></pre></td></tr></table>
</div>
</div><h3 id="heading">日志记录丢弃包的信息</h3>
<p>使用的参数为 <code>--set-log-denied</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">// 查看信息
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --get-log-denied</span>
off
// 设置
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --set-log-denied=all</span>
success
</code></pre></td></tr></table>
</div>
</div><p>除了直接设置 all ，也可以分类设置</p>
<ul>
<li>unicast</li>
<li>broadcast</li>
<li>multicast</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --set-log-denied=multicast</span>
success
<span class="o">[</span>root@centos8 firewalld<span class="o">]</span><span class="c1"># sudo firewall-cmd --get-log-denied</span>
multicast
</code></pre></td></tr></table>
</div>
</div><p>红帽系的系统将 包阻断相关日志放在了 /var/log/messages</p>
<h3 id="-rich-language-rules">编写 rich language rules</h3>
<p>之前的端口，服务等规则添加能够满足日常简单的需求，但是 更加精细的控制就需要使用到叫做 &lsquo;富语言规则'的东西。</p>
<p>先来一个例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --add-rich-rule<span class="o">=</span><span class="s1">&#39;rule family=&#34;ipv4&#34; source address=&#34;200.192.0.0/24&#34; service name=&#34;http&#34; drop&#39;</span>

<span class="o">[</span>root@centos8 ~<span class="o">]</span><span class="c1"># sudo firewall-cmd --info-zone=dmz</span>
dmz <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: enp0s5
  sources:
  services: http ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks: host-redirect network-redirect
  rich rules:
	rule <span class="nv">family</span><span class="o">=</span><span class="s2">&#34;ipv4&#34;</span> <span class="nb">source</span> <span class="nv">address</span><span class="o">=</span><span class="s2">&#34;200.192.0.0/24&#34;</span> service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;http&#34;</span> drop
</code></pre></td></tr></table>
</div>
</div><p>这是一条阻止一个C类网段访问网站的规则，表示作用于ipv4网络，地址为 200.192.0.0/24 的IP无法访问该服务器的HTTP服务。 可以看到新加的规则显示在了最后。IPv6的规则同理，只需要将 family 换成 ipv6。</p>
<p>有些规则是同时作用于IPv4和IPv6。比如，添加 Network Time Protocol(NTP) 服务规则，并且每分钟记录一条规则。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo firewall-cmd --add-rich-rule<span class="o">=</span><span class="s1">&#39;rule service name=&#34;ntp&#34; audit limit value=&#34;1/m&#34; accept&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>更详细的规则，可以通过 man firewalld.richlanguage 来查看 。现在添加的这些规则可以在 .xml 文件中看到，因为我的默认 zone 一直是 dmz ，所以可以查看一下 /etc/firewalld/zones/dmz.xml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@centos8 ~<span class="o">]</span><span class="c1"># cat /etc/firewalld/zones/dmz.xml</span>
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
&lt;zone&gt;
  &lt;short&gt;DMZ&lt;/short&gt;
  &lt;description&gt;For computers in your demilitarized zone that are publicly-accessible with limited access to your internal network. Only selected incoming connections are accepted.&lt;/description&gt;
  &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;ssh&#34;</span>/&gt;
  &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;http&#34;</span>/&gt;
  &lt;icmp-block <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;host-redirect&#34;</span>/&gt;
  &lt;icmp-block <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;network-redirect&#34;</span>/&gt;
  &lt;rule <span class="nv">family</span><span class="o">=</span><span class="s2">&#34;ipv4&#34;</span>&gt;
    &lt;<span class="nb">source</span> <span class="nv">address</span><span class="o">=</span><span class="s2">&#34;200.192.0.0/24&#34;</span>/&gt;
    &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;http&#34;</span>/&gt;
    &lt;drop/&gt;
  &lt;/rule&gt;
  &lt;rule&gt;
    &lt;service <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;ntp&#34;</span>/&gt;
    &lt;audit&gt;
      &lt;limit <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;1/m&#34;</span>/&gt;
    &lt;/audit&gt;
    &lt;accept/&gt;
  &lt;/rule&gt;
&lt;/zone&gt;
</code></pre></td></tr></table>
</div>
</div><p>后来添加的富语言规则都是以 rule 为标签。</p>
<h2 id="heading-1">推荐阅读</h2>
<ul>
<li>nftables wiki: <a href="https://wiki.nftables.org/wiki-nftables/index.php/Main_Page">https://wiki.nftables.org/wiki-nftables/index.php/Main_Page</a></li>
<li>firewalld documentation for RHEL 7: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-using_firewalls">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-using_firewalls</a></li>
<li>firewalld documentation for RHEL 8: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/securing_networks/using-and-configuring-firewalls_securing-networks">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/securing_networks/using-and-configuring-firewalls_securing-networks</a></li>
<li>The firewalld home page: <a href="https://firewalld.org/">https://firewalld.org/</a></li>
<li>nftables examples: <a href="https://wiki.gentoo.org/wiki/Nftables/Examples">https://wiki.gentoo.org/wiki/Nftables/Examples</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Morgana</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-03-11
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/firewall/">firewall</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2020/03/16/restful-web-services-with-go-3/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Restful Web Services With Go (3)</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2020/03/10/linux-%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%89%E5%85%A81/">
            <span class="next-text nav-default">Linux 防火墙安全（1）</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:fivestrong@live.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/fivestrong" class="iconfont icon-github" title="github"></a>
  <a href="http://linuxfunk.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2015 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Morgana</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>








</body>
</html>
