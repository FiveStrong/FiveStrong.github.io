<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Restful Web Services With Go (3) - モルガンナの家</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Morgana" /><meta name="description" content="学习目标： 理解Go自带的 net/http 包 Go基本路由-ServeMux 轻量级 HTTP 路由 - httprouter 重量级 HTTP 路由 - gorilla/mux 构建一个短链接服务API 理解Go net/http 包 一个Web服务" /><meta name="keywords" content="Hugo, モルガンナの家" />






<meta name="generator" content="Hugo 0.61.0 with theme even" />


<link rel="canonical" href="http://linuxfunk.com/2020/03/16/restful-web-services-with-go-3/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.c6027d52fe21dac0e1e0f5d733e108dbb77b0720664fde93151746da29085e21.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Restful Web Services With Go (3)" />
<meta property="og:description" content="学习目标： 理解Go自带的 net/http 包 Go基本路由-ServeMux 轻量级 HTTP 路由 - httprouter 重量级 HTTP 路由 - gorilla/mux 构建一个短链接服务API 理解Go net/http 包 一个Web服务" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://linuxfunk.com/2020/03/16/restful-web-services-with-go-3/" />
<meta property="article:published_time" content="2020-03-16T15:03:35+08:00" />
<meta property="article:modified_time" content="2020-03-16T15:03:35+08:00" />
<meta itemprop="name" content="Restful Web Services With Go (3)">
<meta itemprop="description" content="学习目标： 理解Go自带的 net/http 包 Go基本路由-ServeMux 轻量级 HTTP 路由 - httprouter 重量级 HTTP 路由 - gorilla/mux 构建一个短链接服务API 理解Go net/http 包 一个Web服务">
<meta itemprop="datePublished" content="2020-03-16T15:03:35&#43;08:00" />
<meta itemprop="dateModified" content="2020-03-16T15:03:35&#43;08:00" />
<meta itemprop="wordCount" content="5296">



<meta itemprop="keywords" content="restful," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Restful Web Services With Go (3)"/>
<meta name="twitter:description" content="学习目标： 理解Go自带的 net/http 包 Go基本路由-ServeMux 轻量级 HTTP 路由 - httprouter 重量级 HTTP 路由 - gorilla/mux 构建一个短链接服务API 理解Go net/http 包 一个Web服务"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">モルガンナの家</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">モルガンナの家</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Restful Web Services With Go (3)</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-16 </span>
        <div class="post-category">
            <a href="/categories/golang/"> golang </a>
            </div>
          <span class="more-meta"> 约 5296 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#go-nethttp-">理解Go net/http 包</a></li>
        <li><a href="#go--servemux">Go 基础路由管理器 ServeMux</a>
          <ul>
            <li><a href="#-servemux--uuidapi">使用 ServeMux 开发一个 生成UUID的API</a></li>
            <li><a href="#-servemux-">使用 ServeMux 添加多个路由</a></li>
          </ul>
        </li>
        <li><a href="#-httprouter">轻量级路由管理 Httprouter</a>
          <ul>
            <li><a href="#-httprouter-1">简单使用 httprouter</a></li>
            <li><a href="#heading">构建一个简单的静态文件服务器</a></li>
          </ul>
        </li>
        <li><a href="#-gorillamux">强大的路由管理 gorilla/mux</a>
          <ul>
            <li><a href="#-gorillamux-1">简单使用 gorilla/mux</a></li>
            <li><a href="#gorillamux-">gorilla/mux 的其他特性</a></li>
          </ul>
        </li>
        <li><a href="#sql-">避免常见的SQL 注入</a></li>
        <li><a href="#urlapi">实现一个URL转化短链接的API</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>学习目标：</p>
<ul>
<li>理解Go自带的 <code>net/http</code> 包</li>
<li>Go基本路由-ServeMux</li>
<li>轻量级 HTTP 路由 - httprouter</li>
<li>重量级 HTTP 路由 - gorilla/mux</li>
<li>构建一个短链接服务API</li>
</ul>
<h2 id="go-nethttp-">理解Go net/http 包</h2>
<p>一个Web服务的基本功能就是响应HTTP请求，Go语言自带了一个 <code>net/http</code> 包，可以用来创建HTTP服务以及客户端。</p>
<p>可以通过一个例子来了解一下这个包的使用，创建的这个服务是接受请求，返回服务器时间。</p>
<ol>
<li>
<p>在你的工作目录下新建项目目录，并使用 go module 初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mkdir healthCheck
<span class="nb">cd</span> healthCheck
go mod init healthCheck
touch main.go
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>编辑 main.go 文件，导入包 net/http 创建路由函数 HealthCheck，其中 <code>http.HandleFunc</code> 接收一个路由以及路由方法，返回 <code>http.ResponseWriter</code>。 ListenAndServe 创建一个HTTP服务，如果创建失败就报错；第一参数是 address:port 格式的监听地址端口，第二参数是使用的路由引擎，这里传入 nil 表示使用默认的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
   
<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;io&#34;</span>
 <span class="s">&#34;log&#34;</span>
 <span class="s">&#34;net/http&#34;</span>
 <span class="s">&#34;time&#34;</span>
<span class="p">)</span>
   
   
<span class="c1">// HealthCheck API returns date time to client
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">HealthCheck</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
 <span class="nx">currentTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span>
 <span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">currentTime</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
 <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/health&#34;</span><span class="p">,</span> <span class="nx">HealthCheck</span><span class="p">)</span>
 <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>打开另外一个 shell 或者 浏览器，访问创建的路由。这里使用 curl 请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">➜</span>  <span class="err">~</span> <span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//localhost:8000/health
</span><span class="c1"></span><span class="mi">2020</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">16</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">43.661315</span> <span class="o">+</span><span class="mi">0</span><span class="mi">800</span> <span class="nx">CST</span> <span class="nx">m</span><span class="p">=</span><span class="o">+</span><span class="mf">97.612028469</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Go 有多种方法处理请求以及响应，这里使用的是 io 包写入响应。在Web开发中，我们更多的是使用模板来生成响应。Go默认的URL handlers 使用的是 ServeMux，下面来更详细的认识一下。</p>
<h2 id="go--servemux">Go 基础路由管理器 ServeMux</h2>
<p>ServeMux 是一个HTTP请求的多路复用器。它使用 ServeHTTP 函数来处理分离路由的逻辑，所以如果我们在一个 Go 结构体中实现了 ServeHTTP 方法，我们也可以自己创建一个路由的多路复用器。</p>
<p>路由与响应函数的关系类似于 Go 中的字典(map)，路由作为 key ，函数作为 value。每次请求，Go都会查找这个字典，找到匹配的路由，执行相应的 ServeHTTP函数。接下来我们以一个生成 UUID 的API作为例子。</p>
<h3 id="-servemux--uuidapi">使用 ServeMux 开发一个 生成UUID的API</h3>
<p>UUID是资源或事务的唯一标识符，在 HTTP 请求认证中经常使用到。</p>
<ol>
<li>
<p>在你的工作目录下新建项目目录，并使用 go module 初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mkdir uuidGenerator
<span class="nb">cd</span> uuidGenerator
go mod init uuidGenerato
创建如下结构文件
├── go.mod
├── main.go
└── uuid
    └── uuidGenerator.go
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>任何实现了特定的HTTP方法的结构体都可以成为 ServeMux。比如，我们创建一个 UUID struct 并实现 ServeHTTP 方法，以下代码在 uuidGenerator.go 中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">uuidGenerator</span>
   
<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;crypto/rand&#34;</span>
 <span class="s">&#34;fmt&#34;</span>
 <span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>
   
<span class="c1">// UUID is a custom multiplexer
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">UUID</span> <span class="kd">struct</span> <span class="p">{</span>
   
<span class="p">}</span>
   
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">UUID</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
 <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
     <span class="nf">giveRandomUUID</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
     <span class="k">return</span> 
 <span class="p">}</span>
 <span class="nx">http</span><span class="p">.</span><span class="nf">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
 <span class="k">return</span> 
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">giveRandomUUID</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">c</span> <span class="o">:=</span> <span class="mi">10</span>
 <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
 <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
 <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
     <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的 UUID 结构体的作用类似于 ServeMux。我们可以通过获取不同的请求的URL路径，来指定相应的响应函数。这里的 giveRandomUUID 就是这样的函数。而 crypto 包中 Read 函数可以向一个 byte array 中随机的填入数字。</p>
</li>
<li>
<p>接下来在主函数中使用我们创建的这个结构体，将它传入到 http.ListenAndServe 方法中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
   
<span class="kn">import</span> <span class="s">&#34;net/http&#34;</span>
<span class="kn">import</span> <span class="nx">u</span> <span class="s">&#34;uuidgenerator/uuid&#34;</span>
   
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
 <span class="nx">mux</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">UUID</span><span class="p">{</span><span class="p">}</span>
 <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 curl 测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">➜</span>  <span class="err">~</span> <span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//localhost:8000/
</span><span class="c1"></span><span class="mi">26</span><span class="nx">ff6499344867139997</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="-servemux-">使用 ServeMux 添加多个路由</h3>
<p>假设我们现在需要一个API用来随机生成不同类型的数字，比如整型、浮点型等等。当有多段路由需要匹配对应响应函数，这时候自定义mux就需要通过多个 if/else 判断条件来检测不同 URL 。为了简化操作，我们使用Go内置的 ServeMux 来处理多段路由，内置ServeMux的使用代码大致如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">newMux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>
<span class="nx">newMux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/randomFloat&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">newMux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/randomInt&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在项目目录下新建 main.go 完整的代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;math/rand&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">newMux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">newMux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/randomFloat&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

	<span class="nx">newMux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/randomInt&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="nx">newMux</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>测试结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span> 
<span class="err">➜</span>  <span class="err">~</span> <span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8000/randomFloat
</span><span class="c1"></span><span class="mf">0.6046602879796196</span>
<span class="err">➜</span>  <span class="err">~</span> <span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8000/randomInt
</span><span class="c1"></span><span class="mi">87</span>
</code></pre></td></tr></table>
</div>
</div><p>这些是Go提供的基本路由管理功能，接下来介绍一些更加流行并且用途比较广泛的路由管理框架。</p>
<h2 id="-httprouter">轻量级路由管理 Httprouter</h2>
<p><code>httprouter</code> 是一个可以通过API优雅管理简单路由的框架。如果使用过Django框架的用户，<code>httprouter</code> 提供相似的功能</p>
<ul>
<li>允许路径变量</li>
<li>适配REST方法（GET,POST,PUT等等）</li>
<li>不影响性能</li>
</ul>
<p><code>httprouter</code> 的其他优势：</p>
<ul>
<li>与内置的 <code>http.Handler</code> 兼容</li>
<li>明确了请求的匹配方式，匹配到一条，或者一条也匹配不到</li>
<li>路由的设计鼓励构建合理的、分层的 RESTful APIs</li>
<li>可以构建简单高效的静态文件系统</li>
</ul>
<h3 id="-httprouter-1">简单使用 httprouter</h3>
<ol>
<li>
<p>通过 go get 安装 <code>httprouter</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">julienschmidt</span><span class="o">/</span><span class="nx">httprouter</span>
   
<span class="nx">导入</span>
<span class="kn">import</span> <span class="s">&#34;github.com/julienschmidt/httprouter&#34;</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>简单案例：获取Go编译器版本；获取给定文件内容</p>
</li>
<li>
<p>创建项目</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">touch</span> <span class="nx">httprouterExample</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="k">go</span> <span class="nx">mod</span> <span class="nx">init</span> <span class="nx">httproute</span>
</code></pre></td></tr></table>
</div>
</div><p>预先定义的路由是：</p>
<ul>
<li>/api/v1/go-version</li>
<li>/api/v1/show-file/:name   // :name 路径参数，Go默认路由没有这个功能</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
   
<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;fmt&#34;</span>
 <span class="s">&#34;log&#34;</span>
 <span class="s">&#34;io&#34;</span>
 <span class="s">&#34;net/http&#34;</span>
 <span class="s">&#34;os/exec&#34;</span>
   
 <span class="s">&#34;github.com/julienschmidt/httprouter&#34;</span>
<span class="p">)</span>
   
   
<span class="kd">func</span> <span class="nf">getCommandOutput</span><span class="p">(</span><span class="nx">command</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">arguments</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
 <span class="nx">out</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">arguments</span><span class="o">...</span><span class="p">)</span><span class="p">.</span><span class="nf">Output</span><span class="p">(</span><span class="p">)</span>
 <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">goVersion</span> <span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">params</span> <span class="nx">httprouter</span><span class="p">.</span><span class="nx">Params</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">response</span> <span class="o">:=</span> <span class="nf">getCommandOutput</span><span class="p">(</span><span class="s">&#34;/usr/local/bin/go&#34;</span><span class="p">,</span> <span class="s">&#34;version&#34;</span><span class="p">)</span>
 <span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
 <span class="k">return</span> 
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">getFileContent</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">params</span> <span class="nx">httprouter</span><span class="p">.</span><span class="nx">Params</span><span class="p">)</span><span class="p">{</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nf">getCommandOutput</span><span class="p">(</span><span class="s">&#34;/bin/cat&#34;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nf">ByName</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">router</span> <span class="o">:=</span> <span class="nx">httprouter</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="p">)</span>
 <span class="nx">router</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/api/v1/go-version&#34;</span><span class="p">,</span> <span class="nx">goVersion</span><span class="p">)</span>
 <span class="nx">router</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/api/v1/show-file/:name&#34;</span><span class="p">,</span> <span class="nx">getFileContent</span><span class="p">)</span>
   
 <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到代码中用到了 <code>exec.Command</code> 来执行系统命令，Output 方法返回执行结果。在两个路由函数中都用到了这个功能。</p>
<p>在相同的目录下创建两个测试用的文本文件</p>
<p>Greek.txt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-reStructuredText" data-lang="reStructuredText">Οἱ δὲ Φοίνιϰες οὗτοι οἱ σὺν Κάδμῳ ἀπιϰόμενοι.. ἐσήγαγον διδασϰάλια ἐς τοὺς ῞Ελληνας ϰαὶ δὴ ϰαὶ γράμματα, οὐϰ ἐόντα πρὶν ῞Ελλησι ὡς ἐμοὶ δοϰέειν, πρῶτα μὲν τοῖσι ϰαὶ ἅπαντες χρέωνται Φοίνιϰες· μετὰ δὲ χρόνου προβαίνοντος ἅμα τῇ ϕωνῇ μετέβαλον ϰαὶ τὸν ϱυϑμὸν τῶν γραμμάτων. Περιοίϰεον δέ σϕεας τὰ πολλὰ τῶν χώρων τοῦτον τὸν χρόνον ῾Ελλήνων ῎Ιωνες· οἳ παραλαβόντες διδαχῇ παρὰ τῶν Φοινίϰων τὰ γράμματα, μεταρρυϑμίσαντές σϕεων ὀλίγα ἐχρέωντο, χρεώμενοι δὲ ἐϕάτισαν, ὥσπερ ϰαὶ τὸ δίϰαιον ἔϕερε ἐσαγαγόντων Φοινίϰων ἐς τὴν ῾Ελλάδα, ϕοινιϰήια ϰεϰλῆσϑαι.<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Chinese.txt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-reStructuredText" data-lang="reStructuredText">登鹳雀楼<span class="err">
</span><span class="err"></span>唐代：王之涣<span class="err">
</span><span class="err"></span>   <span class="err">
</span><span class="err"></span>白日依山尽，黄河入海流。<span class="err">
</span><span class="err"></span>欲穷千里目，更上一层楼。<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>运行程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><p>通过浏览器或者curl来获取结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">➜  ~ curl -X GET http://127.0.0.1:8000/api/v1/go-version
go version go1.14 darwin/amd64
➜  ~ curl -X GET http://127.0.0.1:8000/api/v1/show-file/greek.txt
Οἱ δὲ Φοίνιϰες οὗτοι οἱ σὺν Κάδμῳ ἀπιϰόμενοι.. ἐσήγαγον διδασϰάλια ἐς τοὺς ῞Ελληνας ϰαὶ δὴ ϰαὶ γράμματα, οὐϰ ἐόντα πρὶν ῞Ελλησι ὡς ἐμοὶ δοϰέειν, πρῶτα μὲν τοῖσι ϰαὶ ἅπαντες χρέωνται Φοίνιϰες· μετὰ δὲ χρόνου προβαίνοντος ἅμα τῇ ϕωνῇ μετέβαλον ϰαὶ τὸν ϱυϑμὸν τῶν γραμμάτων. Περιοίϰεον δέ σϕεας τὰ πολλὰ τῶν χώρων τοῦτον τὸν χρόνον ῾Ελλήνων ῎Ιωνες· οἳ παραλαβόντες διδαχῇ παρὰ τῶν Φοινίϰων τὰ γράμματα, μεταρρυϑμίσαντές σϕεων ὀλίγα ἐχρέωντο, χρεώμενοι δὲ ἐϕάτισαν, ὥσπερ ϰαὶ τὸ δίϰαιον ἔϕερε ἐσαγαγόντων Φοινίϰων ἐς τὴν ῾Ελλάδα, ϕοινιϰήια ϰεϰλῆσϑαι.
➜  ~ curl -X GET http://127.0.0.1:8000/api/v1/show-file/chinese.txt
登鹳雀楼
唐代：王之涣
   
白日依山尽，黄河入海流。
欲穷千里目，更上一层楼。
</code></pre></td></tr></table>
</div>
</div><h3 id="heading">构建一个简单的静态文件服务器</h3>
<p>通常，为了提供给客户端从服务器端获取静态文件的服务，我们需要借助Apache2或者Nginx。我们也可以使用 httprouter 自己实现一个。</p>
<p>为了提供从Go server 获取文件的功能，我们需要定义一个特定的路由，比如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="o">/</span><span class="nx">static</span><span class="o">/</span><span class="o">*</span>
</code></pre></td></tr></table>
</div>
</div><p>思路是使用 http 包提供的 Dir 方法加载文件，将获取到的信息返回给 httprouter。httprouter 还提供了一个好用的 ServeFiles 函数，能够映射获取到的文件。</p>
<p>接下来创建一个 static 静态目录，位置根据自己的实际情况自定义.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mkdir -p /users/git-user/static
</code></pre></td></tr></table>
</div>
</div><p>将上面的Greek.txt Chinese.txt 拷贝到这个目录下，作为示例使用。</p>
<ol>
<li>
<p>创建项目目录，配置go mod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mkdir fileServer
touch fileServer/main.go
go mod init fileserver
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>编写 main.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
      
<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;log&#34;</span>
  <span class="s">&#34;net/http&#34;</span>
      
  <span class="s">&#34;github.com/julienschmidt/httprouter&#34;</span>
<span class="p">)</span>
      
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">router</span> <span class="o">:=</span> <span class="nx">httprouter</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="p">)</span>
      
  <span class="c1">// Mapping to methods is possible with HttpRouter
</span><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">ServeFiles</span><span class="p">(</span><span class="s">&#34;/static/*filepath&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;/Users/git-user/static&#34;</span><span class="p">)</span><span class="p">)</span>
      
  <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>运行程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">go run main.go
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">➜  ~ curl -X GET http://127.0.0.1:8000/static/chinese.txt
登鹳雀楼
唐代：王之涣
      
白日依山尽，黄河入海流。
欲穷千里目，更上一层楼。
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ol>
<h2 id="-gorillamux">强大的路由管理 gorilla/mux</h2>
<p>Mux 表示 多路复用器（multiplexer），gorilla/mux 的设计目标就是实现处理多个HTTP路由与不同 handlers 对应关系。Handlers 可以简单的理解为处理相应请求的对应函数。</p>
<p>Gorilla/mux 有以下特性：</p>
<ul>
<li>路径匹配</li>
<li>查询参数匹配</li>
<li>域名匹配</li>
<li>二级域名匹配</li>
<li>反向URL生成</li>
</ul>
<h3 id="-gorillamux-1">简单使用 gorilla/mux</h3>
<ol>
<li>
<p>获取包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">go get -u github.com/gorilla/mux
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>包导入使用方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/gorilla/mux&#34;</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>gorilla/mux 处理 handler 的方式跟基本的 ServeMux 类似，但是不同于 httprouter ，它将HTTP所有的请求信息都封装到了一个请求对象中。</p>
<p>Gorilla/mux API 提供了三个重要的工具</p>
<ul>
<li>mux.NewRouter 方法</li>
<li>*http.Request 对象</li>
<li>*http.ResponseWriter 对象</li>
</ul>
<p>NewRouter 方法创建一个新的 router 实例，用于映射路由和处理函数。gorilla/mux 向处理函数传递封装过的 *http.Request *http.ResponseWriter 对象，这些对象包含很多额外信息，比如 headers, path parmeters, request body, query parameters。接下来学习一下使用两种不同的风格来定义和使用路由。</p>
<h4 id="heading-1">路径匹配</h4>
<p>一个基于 GET 方法的路径匹配的 URL 如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">https://example.org/articles/books/123
</code></pre></td></tr></table>
</div>
</div><p>这里的基础路径为 <a href="https://example.org/articles/">https://example.org/articles/</a> 其中的 books 123 都是路径参数，下面的例子来介绍怎么获取以及使用这些参数。</p>
<ol>
<li>
<p>创建项目，初始化 go mod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mkdir muxRouter
touch muxRouter/main.go
go mod init muxrouter
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>代码实现 main.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
   
<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;fmt&#34;</span>
 <span class="s">&#34;log&#34;</span>
 <span class="s">&#34;net/http&#34;</span>
 <span class="s">&#34;time&#34;</span>
   
 <span class="s">&#34;github.com/gorilla/mux&#34;</span>
<span class="p">)</span>
   
   
<span class="kd">func</span> <span class="nf">ArticleHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
 <span class="nx">vars</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
 <span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Category is: %v\n&#34;</span><span class="p">,</span> <span class="nx">vars</span><span class="p">[</span><span class="s">&#34;category&#34;</span><span class="p">]</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;ID is: %v\n&#34;</span><span class="p">,</span> <span class="nx">vars</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">]</span><span class="p">)</span>
<span class="p">}</span>
   
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">r</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="p">)</span>
   
 <span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/articles/{category}/{id:[0-9]+}&#34;</span><span class="p">,</span> <span class="nx">ArticleHandler</span><span class="p">)</span>
 <span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
     <span class="nx">Handler</span><span class="p">:</span> <span class="nx">r</span><span class="p">,</span>
     <span class="nx">Addr</span><span class="p">:</span> <span class="s">&#34;127.0.0.1:8000&#34;</span><span class="p">,</span>
     <span class="nx">WriteTimeout</span><span class="p">:</span> <span class="mi">15</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
     <span class="nx">ReadTimeout</span><span class="p">:</span> <span class="mi">15</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
 <span class="p">}</span>
 <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">srv</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>运行程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">go run main.go
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">➜  ~ curl  http://127.0.0.1:8000/articles/books/123
Category is: books
ID is: <span class="m">123</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>上面的例子展示了如何匹配以及解析路径参数，除了这种方法还有一种比较常用的方法是通过请求参数获取。</p>
<h4 id="heading-2">参数匹配</h4>
<p>在HTTP请求中，查询参数和请求URL一同发送，gorilla/mux 会获取并收集这些请求参数。类似URL为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">http://127.0.0.1:8000/articles?id<span class="o">=</span>123<span class="p">&amp;</span><span class="nv">category</span><span class="o">=</span>books  // 所有的请求参数以 ？ 开始
</code></pre></td></tr></table>
</div>
</div><p>接下来将上面的程序修改一下，换成通过请求参数匹配。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 在 main.go 文件中添加
</span><span class="c1"></span><span class="nx">r</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="p">)</span>
<span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/articles&#34;</span><span class="p">,</span> <span class="nx">QueryHandler</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>编写新的 QueryHandler 函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// QueryHandler handles the given query parameters
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="p">{</span>
	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Got parameter id:%s!\n&#34;</span><span class="p">,</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Got parameter category:%s!&#34;</span><span class="p">,</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;category&#34;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>运行并测试程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>

<span class="nx">curl</span>  <span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8000/articles\?id\=1234\&amp;category\=birds //在shell中需要转义符
</span><span class="c1"></span><span class="nx">Got</span> <span class="nx">parameter</span> <span class="nx">id</span><span class="p">:</span><span class="mi">1234</span><span class="p">!</span>
<span class="nx">Got</span> <span class="nx">parameter</span> <span class="nx">category</span><span class="p">:</span><span class="nx">birds</span><span class="p">!</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="gorillamux-">gorilla/mux 的其他特性</h3>
<p>第一个就是它可以更具 <code>reverse mapping</code> 技术生成动态链接，这个链接是一个API资源的完整URL。这样生成的URL需要通过 Name 与路由联系起来，具体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">.</span><span class="nf">HanderFunc</span><span class="p">(</span><span class="s">&#34;/articles/{category}/{id:[0-9]+}&#34;</span><span class="p">,</span> <span class="nx">ArticleHandler</span><span class="p">)</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="s">&#34;articleRoute&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这样我们就可以通过这个名字来动态生成链接了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">url</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;articleRoute&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">URL</span><span class="p">(</span><span class="s">&#34;category&#34;</span><span class="p">,</span> <span class="s">&#34;books&#34;</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;123&#34;</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span> <span class="c1">//打印结果为 /articles/books/123
</span></code></pre></td></tr></table>
</div>
</div><p>如果路由包含其他定义的参数，那么也需要将它传到 URL 方法中。</p>
<p>第二个特性就是 <code>路径前缀（path prefix）</code>, 它可以广泛的匹配所有可能的路径。一个典型的应用就是我们之前遇到过的静态文件服务。当我们从静态目录匹配文件，API路径应该匹配出到所在系统路径，并返回文件内容。</p>
<p>当我们吧 /static/ 定义为路径前缀，下面的路径应该都能匹配到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">http://localhost:8000/static/js/jquery.min.js
http://localhost:8000/static/index.html
http://localhost:8000/static/some_file.extension
</code></pre></td></tr></table>
</div>
</div><p>用gorilla/mux 编写静态文件服务，需要用到的方法有 <code>PathPrefix</code> 和 <code>StripPefix</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">.</span><span class="nf">PathPrefix</span><span class="p">(</span><span class="s">&#34;/static/&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">StripPrefix</span><span class="p">(</span><span class="s">&#34;/static/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;/tmp/static&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>第三个特性是 <code>严格的反斜线 strict slash</code>，激活这个特性可以让一个URL路径重定向到相同的以反斜线结尾的URL，反之亦然。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">.</span><span class="nf">StrictSlash</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="nx">r</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/articles/&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">ArticleHandler</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的例子将这个特性设置为 true，这样的话访问 /articles 也会被重定向，从而执行 ArticleHandler 响应函数；如果设置为 false ，那么 /articles/ 和 /articles 是不同路由路径</p>
<p>第四个特性是可以匹配经过解码的路径参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">.</span><span class="nf">UseEncodedPath</span><span class="p">(</span><span class="p">)</span>
<span class="nx">r</span><span class="p">.</span><span class="nf">NewRoute</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/category/id&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这样匹配下面两个URL都是可行的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">http://localhost:8000/books/2
http://localhost:8000/books%2F2
</code></pre></td></tr></table>
</div>
</div><h2 id="sql-">避免常见的SQL 注入</h2>
<p>SQL注入是常见的攻击数据库的手段。如果一个请求没有做相应的防护，那么攻击者就可以在请求参数中拼接恶意字符串，这条请求直接被后端作为SQL 语句执行的话，就可能会造成潜在的安全事故。</p>
<p>比如说有一段代码，将用户名、密码插入到数据库中。它通过HTTP POST 请求来获取这些值来拼成SQL语句</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">username</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span>
<span class="nx">password</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;category&#34;</span><span class="p">)</span>
<span class="nx">sql</span> <span class="o">:=</span> <span class="s">&#34;SELECT * FROM article WHERE id=&#39;&#34;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s">&#34;&#39; AND category=&#39;&#34;</span> <span class="o">+</span> <span class="nx">password</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span>
<span class="nx">Db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">sql</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的代码直接使用获取到的值，如果这些值包含恶意的SQL 声明，比如说 &ndash; 注释符， ORDER BY n</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">?category<span class="o">=</span>books<span class="p">&amp;</span><span class="nv">id</span><span class="o">=</span><span class="m">10</span> ORDER BY 10--
</code></pre></td></tr></table>
</div>
</div><p>如果程序直接返回数据库相应，这会泄露查询表的信息。然后攻击者通过不断更换参数尝试获取其他敏感信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Unknow column <span class="s1">&#39;10&#39;</span> in <span class="s1">&#39;order clause&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>避免这样的注入，可以使用以下预防措施：</p>
<ul>
<li>在数据库中设置针对不同用户设置对表的权限等级</li>
<li>记录请求，及时发现异常</li>
<li>使用 <code>text/template</code> 包提供的 <code>HTMLEscapeString</code> 方法去过滤参数中的特殊字符</li>
<li>避免使用原生SQL语句，建议使用相应的ORM操作</li>
<li>避免将数据库 debug 信息返回给客户端</li>
<li>使用安全工具，比如 sqlmap ，去定期扫描程序，发现现在的威胁</li>
</ul>
<h2 id="urlapi">实现一个URL转化短链接的API</h2>
<p>这个服务的目标是将一个非常长的URL转换成简洁、清晰、容易记忆的短URL返回给用户。</p>
<p>URL短链接大概需要完成两个功能：</p>
<ul>
<li>实现一个简单的字符串映射算法，将长字符串映射为短字符串(Base 62)</li>
<li>一个简单的Web服务，能够将短URL链接重定向到原始URL</li>
</ul>
<p>URL短链接的好处是：</p>
<ul>
<li>便于用户记忆</li>
<li>可用于有字数限制的地方，比如微博限制140字</li>
<li>可预知的URL长度</li>
</ul>
<p>短链接服务流程：</p>
<ol>
<li>获取原始URL</li>
<li>通过BASE62算法编码，生成短URL</li>
<li>将URL存储到数据库中，并映射到原始URL（[shortened_url : original_url]）</li>
<li>当一个请求通过短链接到达服务器，响应将HTTP重定向到原始URL</li>
</ol>
<p>API设计文档</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>REST Verb</th>
<th>Action</th>
<th>Success</th>
<th>Failure</th>
</tr>
</thead>
<tbody>
<tr>
<td>/api/v1/new</td>
<td>POST</td>
<td>Create a shortened URL</td>
<td>200</td>
<td>500, 404</td>
</tr>
<tr>
<td>/api/v1/:url</td>
<td>GET</td>
<td>Redirect to original URL</td>
<td>301</td>
<td>404</td>
</tr>
</tbody>
</table>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Morgana</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-03-16
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/restful/">restful</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2020/03/18/restful-web-services-with-go-4/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Restful Web Services With Go (4)</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2020/03/11/linux-%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%89%E5%85%A82/">
            <span class="next-text nav-default">Linux 防火墙安全（2）</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:fivestrong@live.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/fivestrong" class="iconfont icon-github" title="github"></a>
  <a href="http://linuxfunk.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2015 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Morgana</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>








</body>
</html>
